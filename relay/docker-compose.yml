# Sova Relay Docker Compose Configuration
# Choose one of the service configurations below based on your deployment needs

services:
  # Option 1: Pre-built binary (Recommended for VPS with limited memory)
  sova-relay-prebuilt:
    build:
      context: ..  # Build from Sova root
      dockerfile: relay/Dockerfile.prebuilt
    container_name: sova-relay
    restart: unless-stopped
    ports:
      - "9090:9090"
      - "8080:8080"
    environment:
      - RUST_LOG=info
    networks:
      - sova-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'
    healthcheck:
      test: ["CMD", "timeout", "5", "bash", "-c", "</dev/tcp/localhost/9090"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Option 2: Full compilation (Requires >4GB RAM)
  # Uncomment this and comment out the above service to use full compilation
  # sova-relay-full:
  #   build:
  #     context: ..  # Build from Sova root
  #     dockerfile: relay/Dockerfile
  #   container_name: sova-relay
  #   restart: unless-stopped
  #   ports:
  #     - "9090:9090"
  #     - "8080:8080"
  #   environment:
  #     - RUST_LOG=info
  #   networks:
  #     - sova-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 256M
  #         cpus: '0.5'
  #       reservations:
  #         memory: 128M
  #         cpus: '0.1'
  #   healthcheck:
  #     test: ["CMD", "timeout", "5", "bash", "-c", "</dev/tcp/localhost/9090"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

networks:
  sova-network:
    driver: bridge

# Optional: Add monitoring with Prometheus
# Uncomment if you want metrics
# prometheus:
#   image: prom/prometheus:latest
#   container_name: sova-prometheus
#   restart: unless-stopped
#   ports:
#     - "9091:9090"
#   volumes:
#     - ./prometheus.yml:/etc/prometheus/prometheus.yml
#   networks:
#     - sova-network